
/*************************************************************
名称：init.c
版本：V1.0_150701
功能：
说明：初始化
 ****************************************************************/
#include "common.h"

flag_bit Flag_Data;

//===============================================================
//系统初始化
//===============================================================

void system_init(void) {
    //----------------------------------------------------------------
    //数据初始化
    //---------------------------------------------------------------- 
    
		
		Flag_Data.Read_Enable = 1;
		Flag_Data.Data_Change = 1;
		Flag_Data.Fan_Door_Delay_Time_End = 1;	
        
		Comp_Move_Time = TIME_4HOUR;		//90分钟
	
		Flag_Data.Key = 1;
    //---------------------------------------------------------------
    //端口初始化
    //---------------------------------------------------------------
		APFCON = 0b01000000;
    //--------------------------------------------------------------
    //PORTA	RA7		RA6				RA5  	RA4     	RA3				RA2     RA1   	RA0
    //			FLZ		Ld_Door2	保留	Comp_PWM	DB_HEAT  	DEF			COOL		FAN_FB
     //PORTA	RA7	负离子	RA6		冷冻门		RA5 保留 	RA4  压缩机PWM   	RA3	挡板加热器			RA2 化霜    RA1   	RA0  风机反馈
    //			0			0					0    	0					0	 				0				0       0
    //--------------------------------------------------------------
    PORTA  = 0b00000000;
    ANSELA = 0b00000000;
    TRISA  = 0b01010001;
    //--------------------------------------------------------------
    //PORTB	RB7					RB6		RB5				RB4		RB3		RB2		RB1	RB0
    //			风门控制	Key		Ld_Light2	LC_AD	HS_AD	LD_AD	JRQ	LIGHT
	  //			风门控制  按键		冷冻灯2 	冷藏传感器	化霜传感器	冷冻传感器	加热器	灯
    //			0						0			0					0			0			0			0		0
    //--------------------------------------------------------------
    PORTB  = 0x00;
    ANSELB = 0b00011100;   
    TRISB  = 0b01111101;
    WPUB   = 0x00;
    //--------------------------------------------------------------
    //PORTC	RC7	RC6	RC5	RC4	RC3		RC2			RC1		RC0
    //		RX	TX	BB	AA	DOOR	Ld_Light1	FAN		Ld_Door1
    //			0		0		0		0		0			0					0			0
    //--------------------------------------------------------------
    PORTC = 0b00000000;
    TRISC = 0b10001111;    
    //---------------------------------------------------------------
    //时钟初始化
    //---------------------------------------------------------------
    //--------------------------------------------------------------
    //OSCCON	SPLLEN	IRCF3	IRCF2	IRCF1	IRCF0	--	SCS1	SCS0
    //				0				1			1     0			1			0		1			1
    //--------------------------------------------------------------
    OSCCON = 0b01100011; //2MHZ
    //--------------------------------------------------------------
    //OSCSTAT	T1OSCR	PLLR	OSTS	HFIOFR	HFIOFL	MFIOR	LFIOFR	HFIOFS
    //				0				0			0			1				0				0			0				1
    //---------------------------------------------------------------
    OSCSTAT = 0x11; //精度为0.5%
    //--------------------------------------------------------------
    //OSCTUNE	--	--	--	TUN4	TUN3	TUN2	TUN1	TUN0
    //				0		0		0		0			0			0			0			0
    //--------------------------------------------------------------
    OSCTUNE = 0x00; //内部校准
  
	
		//void comp_pwm_init(void)		//CCP5
		{
			//TRISA4 = 1;			//RA4  CCP5		Comp_PWM
			PR4 = PR_FREQ_100;
			//------------------------------
			//CCP5CON	P5M1	P5M0	DC5B1	DC5B0	CCP5M3	CCP5M2	CCP5M1	CCP5M0
			//				0			0			1			1			1				1				0				0
			CCP5CON = 0b00111100;
			CCPR5L = CCPR_FREQ_100;		//DC5B1 = 0 DC5B0 = 0;占空比：(CCPR5L<<2+DC5B1<<1+DC5B0)/(4*（PRX+1）) = 51%
			//CCPTMRS0	C4TSEL1	C4TSEL0	C3TSEL1	C3TSEL0	C2TSEL1	C2TSEL0	C1TSEL1	C1TSEL0
			CCPTMRS1 = 0x01;		//CCP5使用定时器4
			TMR4IF = 0; //清除TMR4中断标志
			T4CKPS1 = 1;
			T4CKPS0 = 1;			//预分频64		//PWM周期= [(PRx) + 1] ? 4 ? TOSC ?(TMRx Prescale Value预分频值)注1： TOSC = 1/FOSC
			TMR4ON = 1;			
		}
		//TRISC1 = 1;				//RC1  CCP2		Fan_PWM
		//TRISC2 = 1；			//RC2  CCP1		Ld_Light1_PWM
		//TRISB5 = 1;				//RB5	 CCP3   Ld_Light2_PWM
		//TRISB0 = 1;				//RB0  CCP4		lC_Light_PWM

		PR2 = 249;				//定时器周期
		//------------------------------
		//CCP1CON	P1M1	P1M0	DC1B1	DC1B0	CCP1M3	CCP1M2	CCP1M1	CCP1M0
		//				0			0			0			0			1				1				0				0
		CCP2CON = 0b00001100;
		CCPR2L = 250;		//DC2B1 = 0 DC25B0 = 0;占空比：(CCPR2L<<2+DC2B1<<1+DC2B0)/4*（PRX+1） = 100%	
		//CCP1CON = 0b00001100;
		//CCPR1L = 0;		//DC2B1 = 0 DC25B0 = 0;占空比：(CCPR2L<<2+DC2B1<<1+DC2B0)/4*（PRX+1） = 100%
		//CCP3CON = 0b00001100;
		//CCPR3L = 0;		//DC2B1 = 0 DC25B0 = 0;占空比：(CCPR2L<<2+DC2B1<<1+DC2B0)/4*（PRX+1） = 100%
		CCP4CON = 0b00001100;
		CCPR4L = 0;		//DC2B1 = 0 DC25B0 = 0;占空比：(CCPR2L<<2+DC2B1<<1+DC2B0)/4*（PRX+1） = 100%
		//CCPTMRS0	C4TSEL1	C4TSEL0	C3TSEL1	C3TSEL0	C2TSEL1	C2TSEL0	C1TSEL1	C1TSEL0
		CCPTMRS0 = 0x00;  //CCP1、2、3、4 以定时器2为准
		TMR2IF = 0; //清除TMR0 中断标志
		T2CKPS1 = 0;
		T2CKPS0 = 0;
		TMR2ON = 1;	
    //---------------------------------------------------------------
    //定时器1初始化
    //---------------------------------------------------------------
    //--------------------------------------------------------------
    //T1CON	TMR1CS1	TMR1CS0	T1CKPS1	T1CKPS0	T1OSCEN	T1SYNC	--  TMR1ON
    //			0				0       0				0				0				0				0   0
    //--------------------------------------------------------------
    T1CON = 0x00; //2Mhz/4 = 0.5MHz
    //----------------------------------------------------------------
    //T1GCON	TMR1GE	T1GPOL	T1GTM	T1GGO/GONE  T1GVAL  T1GSS1  T1GSS0
    //				0				0				0			0           0       0       0
    //-----------------------------------------------------------------  
    T1GCON = 0x00;
    TMR1L = 0x0C; //TMR1付初值//采用内部时钟（FOSC/4）即0.5MHz
    TMR1H = 0xFE; //1ms的定时为65536-500=65036即500*2us=1ms中断一次
    TMR1CS1 = 0;
    TMR1CS0 = 0; 	//TIMER1时钟源为系统时钟（FOSC/4）
    T1CKPS1 = 0;
    T1CKPS0 = 0; 	//预分频比 1:1
    TMR1ON = 1; 	//使能TINER1

//---------------------------------------------------------------
		//ad初始化
		//---------------------------------------------------------------	
		ADCON0   = LC_AD_ADDRESS;
		ADFM     = 1;
		GO_nDONE = 1;

	  //====串口设置(说明:接收使能,发送使能,异步通讯,波特率=2400,数据位=8bit,停止位=1bit,无校验位)
		SPBRGH = 0x00; 
		SPBRGL = 0x33;
    //---------------------------------------------------------------------------
    //BAUDCON	ABDOVF	RCIDL   --  SCKP    BRG16   --  WUE ABDEN
    //				0				1				0   0       1       0		0   0
    //---------------------------------------------------------------------------
    BAUDCON |= 0b00001000;
    //--------------------------------------------------------------------------
    //TXSTA	CSRC	TX9	TXEN	SYNC	SENDB	BRGH	TRMT	TX9D
    //			0			0		1			0			0			1			0			0
    //--------------------------------------------------------------------------
    TXSTA = 0b00100100; //异步高速方式,发送8bit 数据,发送使能
    //-------------------------------------------------------------------------
    //RCSTA	SPEN	RX9	SREN	CREN	ADDEN	FERR	OERR	RX9D
    //			1     0		0			1			0			0			0			0
    //-------------------------------------------------------------------------
    RCSTA = 0b10010000; //串口工作使能,接收8bit 数据,连续接收允许
    //---------------------------------------------------------------
    //看门狗初始化
    //---------------------------------------------------------------
    wdt_init();	
    //===============================================================
    //中断使能
    //===============================================================
    //---------------------------------------------------------------
    //INTCON	GIE	PEIE	TMROIE	INTE	IOCIE	TMR0IF	INTF	IOCIF
    //				1   1			1				0			0			0				0       0
    //---------------------------------------------------------------
    INTCON = 0x00;	//中断控制寄存器=0
    //---------------------------------------------------------------
    //PIE1      TMR1GIE ADIE	RCIE	TXIE	SSPIE	CCP1IE	TMR2IE	TMR1IE
    //          0				0			1			0			0			0				0				1
    //---------------------------------------------------------------
    //PIE1 = 0x00;	//外设中断允许寄存器1清零
    //---------------------------------------------------------------
    //PIE2	OSFIE	C2IE	C1IE	EEIE	BCLIE	LCDIE	--	CCP2IE
    //		0	0	0	0	0	0	0	0
    //---------------------------------------------------------------
    //PIE2 = 0x00;
    //---------------------------------------------------------------
    //PIE3	--	CCP5IE	CCP4IE	CCP3IE	TMR6IE	--  TMR4IE  --
    //		0	0	0	0	0	0   0       0
    //---------------------------------------------------------------
    //PIE3   = 0x00;
    PIE1 = 0b00100001;
    INTCON = 0b11000000;  
		//ABDEN  = 1;		//ABDEN  = 1;目前这个位置是正确的，不要往上提。
}

